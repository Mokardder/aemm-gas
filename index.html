<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Inventory Management + Billing System</title>
  <style>
    :root {
      --bg: #f4f6fb;
      --surface: #ffffff;
      --surface-soft: #f8f9ff;
      --text: #1f2a44;
      --muted: #6b7280;
      --primary: #3b82f6;
      --primary-dark: #2563eb;
      --accent: #22c55e;
      --danger: #ef4444;
      --border: #e5e7eb;
      --shadow: 0 10px 30px rgba(17, 24, 39, 0.08);
      --radius: 14px;
      --transition: all 0.25s ease;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: Inter, "Segoe UI", Roboto, Arial, sans-serif;
      color: var(--text);
      background: var(--bg);
    }
    .app {
      display: grid;
      grid-template-columns: 260px 1fr;
      min-height: 100vh;
    }
    .sidebar {
      position: sticky;
      top: 0;
      height: 100vh;
      background: linear-gradient(180deg, #0f172a, #1e293b);
      color: #fff;
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 18px;
    }
    .brand { display: flex; align-items: center; gap: 10px; font-weight: 700; font-size: 1.1rem; }
    .nav-btn {
      width: 100%;
      border: none;
      background: transparent;
      color: #dbeafe;
      text-align: left;
      padding: 12px;
      border-radius: 10px;
      cursor: pointer;
      transition: var(--transition);
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 0.95rem;
    }
    .nav-btn:hover, .nav-btn.active { background: rgba(59,130,246,0.25); color: #fff; }
    .main { padding: 20px; }
    .panel { display: none; }
    .panel.active { display: block; }
    .grid { display: grid; gap: 16px; }
    .cards { grid-template-columns: repeat(auto-fit, minmax(170px, 1fr)); }
    .card {
      background: var(--surface);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 16px;
      border: 1px solid var(--border);
      transition: var(--transition);
    }
    .card:hover { transform: translateY(-3px); }
    .label { font-size: 0.85rem; color: var(--muted); margin: 0 0 6px; }
    .value { font-size: 1.35rem; font-weight: 700; margin: 0; }
    .section-title { margin: 20px 0 10px; }
    .btn {
      border: none;
      background: var(--primary);
      color: #fff;
      padding: 10px 14px;
      border-radius: 10px;
      cursor: pointer;
      transition: var(--transition);
    }
    .btn:hover { background: var(--primary-dark); }
    .btn.ghost { background: #e8efff; color: var(--primary-dark); }
    .btn.danger { background: var(--danger); }
    .btn.success { background: var(--accent); }
    .row { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; }
    input, select, textarea {
      width: 100%;
      padding: 10px;
      border: 1px solid var(--border);
      border-radius: 10px;
      outline: none;
      transition: var(--transition);
      background: #fff;
    }
    input:focus, select:focus, textarea:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(59,130,246,0.14); }
    .toolbar { display: flex; justify-content: space-between; gap: 12px; flex-wrap: wrap; margin-bottom: 10px; }
    .search-wrap { position: relative; min-width: 260px; flex: 1; }
    .search-wrap svg { position: absolute; left: 10px; top: 10px; color: var(--muted); }
    .search-wrap input { padding-left: 34px; }
    table {
      width: 100%; border-collapse: collapse; background: var(--surface); border-radius: var(--radius);
      overflow: hidden; box-shadow: var(--shadow);
    }
    th, td { padding: 12px; border-bottom: 1px solid var(--border); text-align: left; font-size: 0.92rem; }
    th { background: var(--surface-soft); color: var(--muted); font-weight: 600; }
    .actions { display: flex; gap: 8px; }
    .pill { background: #eaf2ff; color: #1d4ed8; border-radius: 999px; padding: 4px 10px; font-size: .78rem; }
    .billing-wrap { display: grid; grid-template-columns: 1.2fr .8fr; gap: 16px; align-items: start; }
    .products-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(170px, 1fr)); gap: 12px; }
    .product-card { background: var(--surface); border: 1px solid var(--border); border-radius: 12px; padding: 12px; cursor: pointer; transition: var(--transition); }
    .product-card:hover { transform: translateY(-4px); box-shadow: var(--shadow); }
    .sticky { position: sticky; top: 10px; }
    .cart-item { display: grid; grid-template-columns: 1fr 80px 90px 90px 70px; gap: 8px; align-items: center; margin: 6px 0; }
    .totals p { margin: 6px 0; display: flex; justify-content: space-between; }
    .totals .grand { font-weight: 700; font-size: 1.1rem; }
    .radio-group { display: flex; gap: 16px; }
    .modal {
      position: fixed; inset: 0; display: none; place-items: center;
      background: rgba(15,23,42,.45); z-index: 10;
    }
    .modal.active { display: grid; }
    .modal-content {
      width: min(680px, 94vw); background: #fff; border-radius: 14px; box-shadow: var(--shadow); padding: 16px;
    }
    .form-grid { display: grid; grid-template-columns: repeat(2,1fr); gap: 10px; }
    .form-grid .full { grid-column: 1/-1; }
    .toast-wrap { position: fixed; right: 16px; top: 16px; display: grid; gap: 8px; z-index: 20; }
    .toast { background: #0f172a; color: #fff; padding: 10px 12px; border-radius: 10px; box-shadow: var(--shadow); }
    .invoice-box { background: #fff; border:1px solid var(--border); border-radius: 12px; padding: 18px; box-shadow: var(--shadow); min-height: calc(100vh - 140px); }
    .invoice-head { display:flex; justify-content: space-between; gap: 12px; border-bottom:1px dashed var(--border); padding-bottom: 12px; margin-bottom: 12px; }
    .logo-ph { width:60px; height:60px; border:2px dashed #cbd5e1; border-radius: 10px; display:grid; place-items:center; color:#64748b; }
    .muted { color: var(--muted); }
    @media (max-width: 1024px) {
      .billing-wrap { grid-template-columns: 1fr; }
      .sticky { position: static; }
    }
    @media (max-width: 860px) {
      .app { grid-template-columns: 1fr; }
      .sidebar { position: static; height: auto; }
      .form-grid { grid-template-columns: 1fr; }
      .cart-item { grid-template-columns: 1fr; border:1px solid var(--border); border-radius: 10px; padding:8px; }
    }
    @media print {
      body * { visibility: hidden; }
      #printableInvoice, #printableInvoice * { visibility: visible; }
      #printableInvoice { position: absolute; left: 0; top: 0; width: 100%; min-height: 100vh; box-shadow:none; border:none; }
      .no-print { display: none !important; }
    }
  </style>
</head>
<body>
<div class="app">
  <aside class="sidebar no-print">
    <div class="brand">
      <svg width="22" height="22" viewBox="0 0 24 24" fill="none"><path d="M12 2l9 4.5v11L12 22l-9-4.5v-11L12 2z" stroke="currentColor"/></svg>
      Smart Inventory Pro
    </div>
    <button class="nav-btn active" data-tab="dashboard">ðŸ“Š Dashboard</button>
    <button class="nav-btn" data-tab="inventory">ðŸ“¦ Inventory</button>
    <button class="nav-btn" data-tab="billing">ðŸ§¾ Billing / Sales</button>
    <button class="nav-btn" data-tab="customers">ðŸ‘¤ Customers</button>
    <button class="nav-btn" data-tab="invoicing">ðŸ“„ Invoicing</button>
  </aside>

  <main class="main">
    <section id="dashboard" class="panel active">
      <h2>Dashboard</h2>
      <div class="grid cards" id="summaryCards"></div>
      <h3 class="section-title">Reports</h3>
      <div class="grid cards" id="reportCards"></div>
      <h3 class="section-title">Quick Actions</h3>
      <div class="row">
        <button class="btn" id="qaAddItem">âž• Add Inventory Item</button>
        <button class="btn" id="qaCreateBill">ðŸ§¾ Create Bill</button>
        <button class="btn" id="qaAddCustomer">ðŸ‘¤ Add Customer</button>
      </div>
    </section>

    <section id="inventory" class="panel">
      <h2>Inventory</h2>
      <div class="toolbar">
        <div class="search-wrap">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none"><circle cx="11" cy="11" r="7" stroke="currentColor"/><path d="M20 20l-4-4" stroke="currentColor"/></svg>
          <input id="inventorySearch" placeholder="Search products..." />
        </div>
        <button class="btn" id="addItemBtn">Add New Item</button>
      </div>
      <div style="overflow:auto">
        <table>
          <thead>
            <tr><th>Item Name</th><th>Description</th><th>Category</th><th>Buying Price</th><th>Selling Price</th><th>Discounted Buying</th><th>Stock</th><th>Actions</th></tr>
          </thead>
          <tbody id="inventoryTableBody"></tbody>
        </table>
      </div>
    </section>

    <section id="billing" class="panel">
      <h2>Billing / Sales</h2>
      <div class="billing-wrap">
        <div class="card">
          <div class="row" style="justify-content:space-between">
            <select id="billingCategoryFilter" style="max-width:220px"></select>
            <div class="search-wrap" style="max-width:320px">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none"><circle cx="11" cy="11" r="7" stroke="currentColor"/><path d="M20 20l-4-4" stroke="currentColor"/></svg>
              <input id="billingSearch" placeholder="Search products" />
            </div>
          </div>
          <div id="productGrid" class="products-grid" style="margin-top:12px"></div>
        </div>

        <div class="card sticky">
          <h3>ðŸ›’ Cart</h3>
          <div id="cartList"></div>
          <div class="totals">
            <p><span>Subtotal</span><strong id="subTotal">â‚¹ 0.00</strong></p>
            <p><span>Discount</span><strong id="totalDiscount">â‚¹ 0.00</strong></p>
            <p><span>Bill Discount</span><span class="row" style="justify-content:flex-end"><select id="billDiscountType" style="width:92px"><option value="fixed">â‚¹</option><option value="percent">%</option></select><input id="billDiscountValue" type="number" min="0" value="0" style="width:90px"/></span></p>
            <p><span>GST</span><span><input id="gstInput" type="number" value="0" min="0" max="50" style="width:70px"/> %</span></p>
            <p class="grand"><span>Grand Total</span><strong id="grandTotal">â‚¹ 0.00</strong></p>
          </div>
          <hr>
          <h4>ðŸ‘¤ Customer</h4>
          <select id="savedCustomerSelect">
            <option value="">Select Saved Customer</option>
          </select>
          <div class="search-wrap">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none"><circle cx="11" cy="11" r="7" stroke="currentColor"/><path d="M20 20l-4-4" stroke="currentColor"/></svg>
            <input id="customerSearch" placeholder="Search saved customer" />
          </div>
          <input id="walkInName" placeholder="Walk-in Customer Name" />
          <input id="walkInPhone" placeholder="Phone Number" />
          <textarea id="walkInAddress" placeholder="Address"></textarea>
          <h4>ðŸ’³ Payment</h4>
          <div class="radio-group">
            <label><input type="radio" name="paymentMode" value="Cash" checked /> Cash</label>
            <label><input type="radio" name="paymentMode" value="Online" /> Online</label>
          </div>
          <button class="btn success" style="width:100%;margin-top:12px" id="proceedInvoice">Proceed to Invoice</button>
        </div>
      </div>
    </section>

    <section id="customers" class="panel">
      <h2>Customers</h2>
      <div class="row" style="margin-bottom:10px"><button class="btn" id="addCustomerBtn">Add Customer</button></div>
      <div style="overflow:auto">
        <table>
          <thead><tr><th>Name</th><th>Phone</th><th>Address</th><th>Total Purchase</th><th>Actions</th></tr></thead>
          <tbody id="customerTableBody"></tbody>
        </table>
      </div>
    </section>

    <section id="invoicing" class="panel">
      <h2>Invoicing</h2>
      <div class="row no-print" style="margin-bottom:8px">
        <input id="companyName" value="Smart Inventory Pro Pvt. Ltd." style="max-width:360px" />
        <button class="btn" id="printBtn">Print / Download PDF</button>
      </div>
      <div id="printableInvoice" class="invoice-box"></div>
    </section>
  </main>
</div>

<div class="modal" id="itemModal"><div class="modal-content">
  <h3 id="itemModalTitle">Add Inventory Item</h3>
  <form id="itemForm" class="form-grid">
    <input class="full" name="name" placeholder="Item Name" required />
    <textarea class="full" name="description" placeholder="Description" required></textarea>
    <input name="category" placeholder="Category" required />
    <input type="number" step="0.01" min="0" name="buyingPrice" placeholder="Buying Price" required />
    <input type="number" step="0.01" min="0" name="sellingPrice" placeholder="Selling Price" required />
    <input type="number" step="0.01" min="0" name="discountedBuying" placeholder="Discounted Buying Option" required />
    <input type="number" min="0" name="stock" placeholder="Stock Quantity" required />
    <div class="full row"><button class="btn" type="submit">Save</button><button class="btn ghost" type="button" data-close="itemModal">Cancel</button></div>
  </form>
</div></div>

<div class="modal" id="customerModal"><div class="modal-content">
  <h3 id="customerModalTitle">Add Customer</h3>
  <form id="customerForm" class="form-grid">
    <input class="full" name="name" placeholder="Customer Name" required />
    <input name="phone" placeholder="Phone" required />
    <textarea class="full" name="address" placeholder="Address" required></textarea>
    <div class="full row"><button class="btn" type="submit">Save</button><button class="btn ghost" type="button" data-close="customerModal">Cancel</button></div>
  </form>
</div></div>

<div class="modal" id="productModal"><div class="modal-content">
  <h3>Add Product to Cart</h3>
  <div id="productModalBody"></div>
</div></div>

<div class="toast-wrap" id="toastWrap"></div>

<script>
  const DB_KEYS = { inventory: 'ims_inventory', customers: 'ims_customers', bills: 'ims_bills' };
  let state = {
    inventory: [], customers: [], bills: [], currentCart: [], editingItemId: null, editingCustomerId: null, selectedProductId: null, selectedCustomerId: '', currentInvoice: null
  };

  const byId = (id) => document.getElementById(id);
  const inr = (n) => new Intl.NumberFormat('en-IN', { style: 'currency', currency: 'INR' }).format(+n || 0).replace('â‚¹', 'â‚¹ ');
  const uid = () => Date.now().toString(36) + Math.random().toString(36).slice(2, 7);
  const showToast = (msg) => {
    const t = document.createElement('div'); t.className = 'toast'; t.textContent = msg;
    byId('toastWrap').appendChild(t); setTimeout(() => t.remove(), 2400);
  };

  const db = {
    load(key, fallback = []) {
      const v = localStorage.getItem(key);
      return v ? JSON.parse(v) : fallback;
    },
    save(key, value) {
      localStorage.setItem(key, JSON.stringify(value));
    }
  };

  function seedData() {
    if (!db.load(DB_KEYS.inventory).length) {
      // @Mokardder - Update inventory data to DB here
      db.save(DB_KEYS.inventory, [
        { id: uid(), name:'Rice 5kg', description:'Premium basmati rice', category:'Grocery', buyingPrice:380, sellingPrice:450, discountedBuying:360, stock:20 },
        { id: uid(), name:'Sunflower Oil', description:'1 litre bottle', category:'Grocery', buyingPrice:120, sellingPrice:155, discountedBuying:110, stock:35 },
        { id: uid(), name:'Dish Soap', description:'Lemon fragrance', category:'Home Care', buyingPrice:38, sellingPrice:55, discountedBuying:34, stock:50 }
      ]);
    }
  }

  function loadState() {
    seedData();
    // @Mokardder - Fetch inventory data from DB here
    state.inventory = db.load(DB_KEYS.inventory, []);
    // @Mokardder - Customer DB operations here
    state.customers = db.load(DB_KEYS.customers, []);
    // @Mokardder - Invoice fetch/store logic here
    state.bills = db.load(DB_KEYS.bills, []);
  }

  function persistInventory() {
    // @Mokardder - Update inventory data to DB here
    db.save(DB_KEYS.inventory, state.inventory);
  }
  function persistCustomers() {
    // @Mokardder - Customer DB operations here
    db.save(DB_KEYS.customers, state.customers);
  }
  function persistBills() {
    // @Mokardder - Invoice fetch/store logic here
    db.save(DB_KEYS.bills, state.bills);
  }

  function dailyMonthlyAnnualStats() {
    const now = new Date();
    const today = now.toISOString().slice(0,10);
    const month = now.getMonth(), year = now.getFullYear();
    const sums = { daily:0, monthly:0, annual:0, revenue:0, dailyQty:0, monthlyQty:0, annualQty:0 };
    state.bills.forEach(b => {
      const d = new Date(b.date);
      sums.revenue += b.grandTotal;
      const qty = b.items.reduce((s, it) => s + it.quantity, 0);
      if (b.date.slice(0,10) === today) { sums.daily += b.grandTotal; sums.dailyQty += qty; }
      if (d.getMonth() === month && d.getFullYear() === year) { sums.monthly += b.grandTotal; sums.monthlyQty += qty; }
      if (d.getFullYear() === year) { sums.annual += b.grandTotal; sums.annualQty += qty; }
    });
    return sums;
  }

  function renderDashboard() {
    const inventoryValue = state.inventory.reduce((s, i) => s + (i.buyingPrice * i.stock), 0);
    const stats = dailyMonthlyAnnualStats();
    const cards = [
      ['Total Products in Inventory', state.inventory.length],
      ['Total Inventory Value (Buying)', inr(inventoryValue)],
      ['Total Revenue', inr(stats.revenue)],
      ['Daily Sales', inr(stats.daily)],
      ['Monthly Sales', inr(stats.monthly)],
      ['Annual Sales', inr(stats.annual)]
    ];
    byId('summaryCards').innerHTML = cards.map(c => `<article class="card"><p class="label">${c[0]}</p><p class="value">${c[1]}</p></article>`).join('');
    byId('reportCards').innerHTML = [
      ['Daily Sell & Revenue Report', `${stats.dailyQty} items â€¢ ${inr(stats.daily)}`],
      ['Monthly Sell & Revenue Report', `${stats.monthlyQty} items â€¢ ${inr(stats.monthly)}`],
      ['Annual Sell & Revenue Report', `${stats.annualQty} items â€¢ ${inr(stats.annual)}`]
    ].map(c => `<article class="card"><p class="label">${c[0]}</p><p class="value">${c[1]}</p></article>`).join('');
  }

  function renderInventory() {
    const q = byId('inventorySearch').value.toLowerCase();
    const rows = state.inventory.filter(i => `${i.name} ${i.description} ${i.category}`.toLowerCase().includes(q));
    byId('inventoryTableBody').innerHTML = rows.map(i => `
      <tr>
        <td>${i.name}</td><td>${i.description}</td><td><span class="pill">${i.category}</span></td>
        <td>${inr(i.buyingPrice)}</td><td>${inr(i.sellingPrice)}</td><td>${inr(i.discountedBuying)}</td><td>${i.stock}</td>
        <td><div class="actions"><button class="btn ghost" onclick="openItemModal('${i.id}')">Edit</button><button class="btn danger" onclick="deleteItem('${i.id}')">Delete</button></div></td>
      </tr>
    `).join('') || `<tr><td colspan="8" class="muted">No inventory records found.</td></tr>`;
  }

  function openItemModal(id = null) {
    state.editingItemId = id;
    const m = byId('itemModal'); const f = byId('itemForm');
    byId('itemModalTitle').textContent = id ? 'Edit Inventory Item' : 'Add Inventory Item';
    f.reset();
    if (id) {
      const p = state.inventory.find(x => x.id === id);
      Object.entries(p).forEach(([k,v]) => f.elements[k] && (f.elements[k].value = v));
    }
    m.classList.add('active');
  }

  function deleteItem(id) {
    if (!confirm('Delete this item permanently?')) return;
    state.inventory = state.inventory.filter(i => i.id !== id);
    persistInventory(); renderAll(); showToast('Inventory item deleted');
  }

  function renderBillingProducts() {
    const categories = ['All', ...new Set(state.inventory.map(i => i.category))];
    byId('billingCategoryFilter').innerHTML = categories.map(c => `<option>${c}</option>`).join('');
    refreshProductGrid();
  }

  function refreshProductGrid() {
    const q = byId('billingSearch').value.toLowerCase();
    const cat = byId('billingCategoryFilter').value || 'All';
    const items = state.inventory.filter(i => (cat === 'All' || i.category === cat) && i.name.toLowerCase().includes(q));
    byId('productGrid').innerHTML = items.map(i => `<div class="product-card" onclick="openProductModal('${i.id}')"><strong>${i.name}</strong><p class="muted">${inr(i.sellingPrice)}</p><small>Stock: ${i.stock}</small></div>`).join('') || '<p class="muted">No products found.</p>';
  }

  function openProductModal(id) {
    const p = state.inventory.find(i => i.id === id);
    if (!p || p.stock <= 0) return showToast('Out of stock');
    state.selectedProductId = id;
    byId('productModalBody').innerHTML = `
      <p><strong>${p.name}</strong></p>
      <p class="muted">${p.description}</p>
      <p>Available stock: ${p.stock}</p>
      <input id="addQty" type="number" min="1" max="${p.stock}" value="1" />
      <div class="row" style="margin-top:10px"><button class="btn" onclick="addToCart()">Add to Cart</button><button class="btn ghost" onclick="closeModal('productModal')">Cancel</button></div>
    `;
    byId('productModal').classList.add('active');
  }

  function addToCart() {
    const qty = +byId('addQty').value;
    const p = state.inventory.find(i => i.id === state.selectedProductId);
    if (!qty || qty < 1 || qty > p.stock) return showToast('Invalid quantity');
    const existing = state.currentCart.find(c => c.id === p.id);
    if (existing) {
      if (existing.quantity + qty > p.stock) return showToast('Stock is insufficient');
      existing.quantity += qty;
    } else {
      state.currentCart.push({ id: p.id, name: p.name, price: p.sellingPrice, quantity: qty, discount: 0 });
    }
    closeModal('productModal'); renderCart(); showToast('Added to cart');
  }

  function renderCart() {
    const list = byId('cartList');
    list.innerHTML = state.currentCart.map(c => `
      <div class="cart-item">
        <strong>${c.name}</strong>
        <input type="number" min="1" value="${c.quantity}" onchange="updateCartQty('${c.id}', this.value)" />
        <span>${inr(c.price)}</span>
        <input type="number" min="0" value="${c.discount}" onchange="updateCartDiscount('${c.id}', this.value)" title="Per-item discount" />
        <button class="btn danger" onclick="removeCartItem('${c.id}')">X</button>
      </div>
    `).join('') || '<p class="muted">Cart is empty.</p>';
    calculateTotals();
  }

  function updateCartQty(id, value) {
    const item = state.currentCart.find(c => c.id === id);
    const inv = state.inventory.find(i => i.id === id);
    const q = +value;
    if (!q || q < 1 || q > inv.stock) return showToast('Stock is insufficient');
    item.quantity = q; renderCart();
  }
  function updateCartDiscount(id, value) {
    const item = state.currentCart.find(c => c.id === id);
    const maxLine = item.price * item.quantity;
    item.discount = Math.min(Math.max(0, +value || 0), maxLine);
    calculateTotals();
  }
  function removeCartItem(id) {
    state.currentCart = state.currentCart.filter(c => c.id !== id); renderCart();
  }

  function calculateTotals() {
    const subtotal = state.currentCart.reduce((s, i) => s + i.price * i.quantity, 0);
    const itemLevelDiscount = state.currentCart.reduce((s, i) => s + i.discount, 0);
    const billDiscountType = byId('billDiscountType').value;
    const billDiscountValue = Math.max(0, +byId('billDiscountValue').value || 0);
    const afterItemDiscount = Math.max(subtotal - itemLevelDiscount, 0);
    const billDiscount = billDiscountType === 'percent'
      ? (afterItemDiscount * Math.min(billDiscountValue, 100) / 100)
      : Math.min(billDiscountValue, afterItemDiscount);
    const discount = itemLevelDiscount + billDiscount;
    const gstPercent = +byId('gstInput').value || 0;
    const taxable = Math.max(afterItemDiscount - billDiscount, 0);
    const gst = taxable * gstPercent / 100;
    const grand = taxable + gst;
    byId('subTotal').textContent = inr(subtotal);
    byId('totalDiscount').textContent = inr(discount);
    byId('grandTotal').textContent = inr(grand);
    return { subtotal, itemLevelDiscount, billDiscountType, billDiscountValue, billDiscount, discount, gstPercent, gst, grand };
  }

  function numberToWordsIndian(num) {
    if (num === 0) return 'Zero Rupees Only';
    const a = ['', 'One','Two','Three','Four','Five','Six','Seven','Eight','Nine','Ten','Eleven','Twelve','Thirteen','Fourteen','Fifteen','Sixteen','Seventeen','Eighteen','Nineteen'];
    const b = ['', '', 'Twenty','Thirty','Forty','Fifty','Sixty','Seventy','Eighty','Ninety'];
    const two = n => n < 20 ? a[n] : b[Math.floor(n/10)] + (n%10 ? ' ' + a[n%10] : '');
    const three = n => {
      const h = Math.floor(n/100), r = n%100;
      return (h ? a[h] + ' Hundred ' : '') + (r ? two(r) : '');
    };
    const parts = [];
    const units = [['Crore', 10000000], ['Lakh', 100000], ['Thousand', 1000], ['Hundred', 100]];
    let n = Math.floor(num);
    for (const [name, val] of units) {
      if (n >= val) {
        const c = Math.floor(n / val);
        parts.push((val===100 ? a[c] : (c<100 ? two(c) : three(c))) + ' ' + name);
        n %= val;
      }
    }
    if (n) parts.push(two(n));
    return parts.join(' ').replace(/\s+/g,' ').trim() + ' Rupees Only';
  }


  function renderCustomerOptions() {
    const select = byId('savedCustomerSelect');
    const q = byId('customerSearch').value.trim().toLowerCase();
    const filtered = state.customers.filter(c => `${c.name} ${c.phone} ${c.address}`.toLowerCase().includes(q));
    select.innerHTML = '<option value="">Select Saved Customer</option>' + filtered.map(c => `<option value="${c.id}">${c.name} (${c.phone})</option>`).join('');
    if (state.selectedCustomerId) select.value = state.selectedCustomerId;
  }

  function applySelectedCustomer(customerId) {
    state.selectedCustomerId = customerId;
    if (!customerId) return;
    const customer = state.customers.find(c => c.id === customerId);
    if (!customer) return;
    byId('walkInName').value = customer.name;
    byId('walkInPhone').value = customer.phone;
    byId('walkInAddress').value = customer.address;
  }

  function proceedInvoice() {
    if (!state.currentCart.length) return showToast('Add items in cart first');
    for (const c of state.currentCart) {
      const inv = state.inventory.find(i => i.id === c.id);
      if (c.quantity > inv.stock) return showToast(`Stock insufficient for ${c.name}`);
    }
    const { subtotal, itemLevelDiscount, billDiscountType, billDiscountValue, billDiscount, discount, gstPercent, gst, grand } = calculateTotals();
    const customer = {
      name: byId('walkInName').value.trim() || 'Walk-in Customer',
      phone: byId('walkInPhone').value.trim() || '-',
      address: byId('walkInAddress').value.trim() || '-'
    };
    if (customer.phone !== '-' && !/^\d{10}$/.test(customer.phone)) return showToast('Phone must be 10 digits');
    const paymentMode = document.querySelector('input[name="paymentMode"]:checked').value;
    state.inventory = state.inventory.map(i => {
      const cart = state.currentCart.find(c => c.id === i.id);
      return cart ? { ...i, stock: i.stock - cart.quantity } : i;
    });
    persistInventory();

    const invoice = {
      id: 'INV-' + Date.now(),
      date: new Date().toISOString(),
      customer,
      items: state.currentCart.map(i => ({ ...i })),
      subtotal, itemLevelDiscount, billDiscountType, billDiscountValue, billDiscount, discount, gstPercent, gst, grandTotal: grand, paymentMode
    };
    // @Mokardder - Save billing transaction to DB here
    state.bills.unshift(invoice);
    persistBills();
    state.currentInvoice = invoice;

    const existingCustomer = state.customers.find(c => c.phone === customer.phone && customer.phone !== '-');
    if (!existingCustomer && customer.phone !== '-') {
      state.customers.push({ id: uid(), ...customer });
      persistCustomers();
    }

    state.currentCart = [];
    state.selectedCustomerId = '';
    byId('savedCustomerSelect').value = '';
    byId('walkInName').value = byId('walkInPhone').value = byId('walkInAddress').value = '';
    renderAll();
    switchTab('invoicing');
    renderInvoice();
    showToast('Invoice generated successfully');
  }

  function renderCustomers() {
    const purchases = {};
    state.bills.forEach(b => {
      const key = b.customer.phone + '|' + b.customer.name;
      purchases[key] = (purchases[key] || 0) + b.grandTotal;
    });
    byId('customerTableBody').innerHTML = state.customers.map(c => {
      const total = purchases[c.phone + '|' + c.name] || 0;
      return `<tr><td>${c.name}</td><td>${c.phone}</td><td>${c.address}</td><td>${inr(total)}</td><td><div class="actions"><button class="btn ghost" onclick="openCustomerModal('${c.id}')">Edit</button><button class="btn danger" onclick="deleteCustomer('${c.id}')">Delete</button></div></td></tr>`;
    }).join('') || '<tr><td colspan="5" class="muted">No customers yet.</td></tr>';
  }

  function openCustomerModal(id = null) {
    state.editingCustomerId = id;
    byId('customerModalTitle').textContent = id ? 'Edit Customer' : 'Add Customer';
    const form = byId('customerForm'); form.reset();
    if (id) {
      const c = state.customers.find(x => x.id === id);
      form.elements.name.value = c.name; form.elements.phone.value = c.phone; form.elements.address.value = c.address;
    }
    byId('customerModal').classList.add('active');
  }

  function deleteCustomer(id) {
    if (!confirm('Delete this customer?')) return;
    // @Mokardder - Customer DB operations here
    state.customers = state.customers.filter(c => c.id !== id);
    persistCustomers(); renderCustomers(); renderCustomerOptions(); showToast('Customer deleted');
  }

  function renderInvoice() {
    const inv = state.currentInvoice || state.bills[0];
    if (!inv) return byId('printableInvoice').innerHTML = '<p class="muted">No invoice generated yet.</p>';
    byId('printableInvoice').innerHTML = `
      <div class="invoice-head">
        <div>
          <div class="logo-ph">Logo</div>
          <h2 style="margin:8px 0 0">${byId('companyName').value}</h2>
          <small class="muted">Professional Billing Invoice</small>
        </div>
        <div style="text-align:right">
          <p><strong>Invoice #:</strong> ${inv.id}</p>
          <p><strong>Date:</strong> ${new Date(inv.date).toLocaleString('en-IN')}</p>
          <p><strong>Payment:</strong> ${inv.paymentMode}</p>
        </div>
      </div>
      <p><strong>Customer:</strong> ${inv.customer.name} | ${inv.customer.phone}</p>
      <p><strong>Address:</strong> ${inv.customer.address}</p>
      <table>
        <thead><tr><th>Product</th><th>Qty</th><th>Price</th><th>Discount</th><th>Total</th></tr></thead>
        <tbody>${inv.items.map(i => `<tr><td>${i.name}</td><td>${i.quantity}</td><td>${inr(i.price)}</td><td>${inr(i.discount)}</td><td>${inr(i.quantity*i.price - i.discount)}</td></tr>`).join('')}</tbody>
      </table>
      <div style="margin-top:10px; max-width:320px; margin-left:auto">
        <p style="display:flex;justify-content:space-between"><span>Subtotal:</span><strong>${inr(inv.subtotal)}</strong></p>
        <p style="display:flex;justify-content:space-between"><span>Item Discount:</span><strong>${inr(inv.itemLevelDiscount || 0)}</strong></p>
        <p style="display:flex;justify-content:space-between"><span>Bill Discount (${inv.billDiscountType === 'percent' ? (inv.billDiscountValue + '%') : 'â‚¹'}):</span><strong>${inr(inv.billDiscount || 0)}</strong></p>
        <p style="display:flex;justify-content:space-between"><span>Total Discount:</span><strong>${inr(inv.discount)}</strong></p>
        <p style="display:flex;justify-content:space-between"><span>GST (${inv.gstPercent}%):</span><strong>${inr(inv.gst)}</strong></p>
        <p style="display:flex;justify-content:space-between;font-size:1.1rem"><span>Total:</span><strong>${inr(inv.grandTotal)}</strong></p>
      </div>
      <p><strong>Amount in Words:</strong> ${numberToWordsIndian(inv.grandTotal)}</p>
      <p style="margin-top:30px; text-align:right">_________________<br><small>Authorized Signature</small></p>
    `;
  }

  function renderAll() {
    renderDashboard(); renderInventory(); renderBillingProducts(); renderCart(); renderCustomers(); renderCustomerOptions(); renderInvoice();
  }

  function closeModal(id) { byId(id).classList.remove('active'); }

  function switchTab(id) {
    document.querySelectorAll('.panel').forEach(p => p.classList.toggle('active', p.id === id));
    document.querySelectorAll('.nav-btn').forEach(b => b.classList.toggle('active', b.dataset.tab === id));
  }

  document.querySelectorAll('.nav-btn').forEach(btn => btn.addEventListener('click', () => switchTab(btn.dataset.tab)));
  document.querySelectorAll('[data-close]').forEach(b => b.addEventListener('click', () => closeModal(b.dataset.close)));

  byId('inventorySearch').addEventListener('input', renderInventory);
  byId('addItemBtn').addEventListener('click', () => openItemModal());
  byId('itemForm').addEventListener('submit', (e) => {
    e.preventDefault();
    const fd = new FormData(e.target);
    const data = Object.fromEntries(fd.entries());
    const item = {
      id: state.editingItemId || uid(),
      name: data.name.trim(), description: data.description.trim(), category: data.category.trim(),
      buyingPrice:+data.buyingPrice, sellingPrice:+data.sellingPrice, discountedBuying:+data.discountedBuying, stock:+data.stock
    };
    if (!item.name || !item.category || item.stock < 0) return showToast('Please fill valid values');
    if (state.editingItemId) state.inventory = state.inventory.map(i => i.id === item.id ? item : i);
    else state.inventory.unshift(item);
    persistInventory(); closeModal('itemModal'); renderAll(); showToast('Inventory saved');
  });

  byId('billingSearch').addEventListener('input', refreshProductGrid);
  byId('billingCategoryFilter').addEventListener('change', refreshProductGrid);
  byId('gstInput').addEventListener('input', calculateTotals);
  byId('billDiscountType').addEventListener('change', calculateTotals);
  byId('billDiscountValue').addEventListener('input', calculateTotals);
  byId('customerSearch').addEventListener('input', renderCustomerOptions);
  byId('savedCustomerSelect').addEventListener('change', (e) => applySelectedCustomer(e.target.value));
  byId('proceedInvoice').addEventListener('click', proceedInvoice);
  byId('addCustomerBtn').addEventListener('click', () => openCustomerModal());
  byId('customerForm').addEventListener('submit', (e) => {
    e.preventDefault();
    const fd = new FormData(e.target);
    const data = Object.fromEntries(fd.entries());
    if (!/^\d{10}$/.test(data.phone.trim())) return showToast('Customer phone must be 10 digits');
    const rec = { id: state.editingCustomerId || uid(), name:data.name.trim(), phone:data.phone.trim(), address:data.address.trim() };
    // @Mokardder - Customer DB operations here
    if (state.editingCustomerId) state.customers = state.customers.map(c => c.id === rec.id ? rec : c);
    else state.customers.unshift(rec);
    persistCustomers(); closeModal('customerModal'); renderCustomers(); renderCustomerOptions(); showToast('Customer saved');
  });

  byId('printBtn').addEventListener('click', () => window.print());
  byId('companyName').addEventListener('input', renderInvoice);
  byId('qaAddItem').addEventListener('click', () => { switchTab('inventory'); openItemModal(); });
  byId('qaCreateBill').addEventListener('click', () => switchTab('billing'));
  byId('qaAddCustomer').addEventListener('click', () => { switchTab('customers'); openCustomerModal(); });

  loadState();
  renderAll();

  window.openItemModal = openItemModal;
  window.deleteItem = deleteItem;
  window.openProductModal = openProductModal;
  window.addToCart = addToCart;
  window.updateCartQty = updateCartQty;
  window.updateCartDiscount = updateCartDiscount;
  window.removeCartItem = removeCartItem;
  window.closeModal = closeModal;
  window.openCustomerModal = openCustomerModal;
  window.deleteCustomer = deleteCustomer;
</script>
</body>
</html>
